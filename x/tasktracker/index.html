<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Fonts & Styles -->
  <meta name="theme-color" content="#1976D2">
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons" rel="stylesheet">
  <link href="https://unpkg.com/vuetify@0.17.0-beta.2/dist/vuetify.min.css" rel="stylesheet">
  <!-- Title -->
  <title>TaskTracker</title>
  <style></style>
</head>
<body>
  <div id="app">
    <v-app>
      <v-navigation-drawer app temporary v-model="drawer">
        <v-toolbar flat>
          <v-list>
            <v-list-tile>
              <v-list-tile-title class="title">
                TaskTracker
              </v-list-tile-title>
            </v-list-tile>
          </v-list>
        </v-toolbar>
        <v-divider></v-divider>
        <v-list dense class="pt-0">
          <!-- <v-list-tile v-for="item in items" :key="item.title" @click="">
            <v-list-tile-action>
              <v-icon>{{ item.icon }}</v-icon>
            </v-list-tile-action>
            <v-list-tile-content>
              <v-list-tile-title>{{ item.title }}</v-list-tile-title>
            </v-list-tile-content>
          </v-list-tile> -->
          <v-list-tile :to="{name: 'tasks'}">
            <v-list-tile-action>
              <v-icon>list</v-icon>
            </v-list-tile-action>
            <v-list-tile-content>
              <v-list-tile-title>Data</v-list-tile-title>
            </v-list-tile-content>
          </v-list-tile>
          <v-list-tile :to="{name: 'charts'}">
            <v-list-tile-action>
              <v-icon>trending_up</v-icon>
            </v-list-tile-action>
            <v-list-tile-content>
              <v-list-tile-title>Charts</v-list-tile-title>
            </v-list-tile-content>
          </v-list-tile>
        </v-list>
      </v-navigation-drawer>
      <v-toolbar app dark color="primary">
        <v-toolbar-title>TaskTracker</v-toolbar-title>
        <v-spacer></v-spacer>
        <v-toolbar-side-icon class="hidden-md-and-up" @click.stop="drawer = !drawer"></v-toolbar-side-icon>
        <v-toolbar-items class="hidden-sm-and-down">
          <v-btn dark flat :to="{name: 'tasks'}">Data</v-btn>
          <v-btn dark flat :to="{name: 'charts'}">Charts</v-btn>
        </v-toolbar-items>
      </v-toolbar>
      <v-content>
        <v-container fluid>
          <router-view></router-view>
          <br>
          <data-component :tasks="tasks"></data-component>
        </v-container>
      </v-content>
      <v-footer app></v-footer>
    </v-app>
  </div>

  <script src="https://unpkg.com/vue@2.5.3/dist/vue.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.6.1/firebase.js"></script>
  <script src="https://unpkg.com/vuefire@1.4.4/dist/vuefire.min.js"></script>
  <!-- <script src="https://unpkg.com/vue-resource@1.3.4/dist/vue-resource.min.js"></script> -->
  <script src="https://unpkg.com/vue-router@2.7.0/dist/vue-router.min.js"></script>
  <script src="https://unpkg.com/vuetify@0.17.0-beta.2/dist/vuetify.min.js"></script>

  <script type="text/x-template" id="data-component-template">
    <div>
      <v-card>
        <v-card-title>
          <v-spacer></v-spacer>
          <v-text-field
            append-icon="search"
            label="Search"
            single-line
            hide-details
            v-model="search"
          ></v-text-field>
        </v-card-title>
        <v-data-table
            v-bind:headers="headers"
            v-bind:items="tasks"
            v-bind:search="search"
          >
          <template slot="items" scope="props">
            <td :class="rowHighlight(props.item)">
              <v-edit-dialog
                lazy
              > {{ props.item.id }}
                <v-text-field
                  slot="input"
                  label="Edit"
                  v-model="props.item.name"
                  single-line
                  counter
                  :rules="[max25chars]"
                ></v-text-field>
              </v-edit-dialog>
            </td>
            <td class="text-xs-right" :class="rowHighlight(props.item)">{{ props.item.type }}</td>
            <td class="text-xs-right" :class="rowHighlight(props.item)">{{ props.item.reporter_id }}</td>
            <td class="text-xs-right" :class="rowHighlight(props.item)">{{ props.item.created_date }}</td>
            <td class="text-xs-right" :class="rowHighlight(props.item)">{{ props.item.completed_date }}</td>
            <td class="text-xs-right" :class="rowHighlight(props.item)">{{ props.item.quantity }}</td>
            <td class="text-xs-right" :class="rowHighlight(props.item)">
              <v-edit-dialog
                @open="tmp = props.item.comment"
                @save="props.item.comment = tmp || props.item.comment"
                large
                lazy
              >
                <div>{{ props.item.comment }}</div>
                <div slot="input" class="mt-3 title">Update comment</div>
                <v-text-field
                  slot="input"
                  label="Edit"
                  v-model="tmp"
                  single-line
                  counter
                  autofocus
                  :rules="[max25chars]"
                ></v-text-field>
              </v-edit-dialog>
            </td>
          </template>
          <template slot="pageText" scope="{ pageStart, pageStop }">
            From {{ pageStart }} to {{ pageStop }}
          </template>
        </v-data-table>
      </v-card>
    </div>
  </script>

  <script type="text/x-template" id="add-task-component-template">
    <div>
      <v-card>
        <v-card-title primary-title>
          <div>
            <h3 class="headline mb-0">New Task</h3>
            <!-- <div>Located two hours south of Sydney in the </div> -->
          </div>
        </v-card-title>
        <v-card-text>
          <v-container fluid>
            <v-form v-model="valid">
              <v-layout row>
                <v-flex xs2>
                  <v-text-field
                    label="Name"
                    v-model="name"
                    :rules="nameRules"
                    :counter="10"
                    required
                  ></v-text-field>
                </v-flex>&nbsp;
                <v-flex xs2>
                  <v-text-field
                    label="E-mail"
                    v-model="email"
                    :rules="emailRules"
                    required
                  ></v-text-field>
                </v-flex>
              </v-layout>
              <!-- <v-layout row>
                <v-flex xs4>
                  <v-subheader>Normal with hint text/label</v-subheader>
                </v-flex>
                <v-flex xs8>
                  <v-text-field
                    label="E-mail"
                    v-model="email"
                    :rules="emailRules"
                    required
                  ></v-text-field>
                </v-flex>
              </v-layout> -->
            </v-form>
          </v-container>
        </v-card-text>
        <v-card-actions>
          <v-btn flat color="primary">Add</v-btn>
          <!-- <v-btn flat color="orange">Explore</v-btn> -->
        </v-card-actions>
      </v-card>
    </div>
  </script>

  <script type="text/x-template" id="charts-component-template">
    <div>
      <h1>charts</h1>
    </div>
  </script>
  
  <script>
    Vue.config.devtools = true

    // Data
    let data = {
      drawer: false,
      right: null,
      tasks: [],
      newTask: {
        id: '',
        type: '',
        reporter_id: '',
        created_date: '',
        completed_date: '',
        quantity: '',
        comment:''
      }
    }

    // Components
    Vue.component('data-component', {
      props: ['tasks'],
      template: '#data-component-template',
      data() {
        return {
        max25chars: (v) => v.length <= 25 || 'Input too long!',
        tmp: '',
        search: '',
        pagination: {},
        headers: [
          {
            text: 'Task',
            align: 'left',
            sortable: false,
            value: 'id'
          },
          { text: 'Type', value: 'type' },
          { text: 'Reporter', value: 'reporter_id' },
          { text: 'Created Date', value: 'created_date' },
          { text: 'Completed Date', value: 'completed_date' },
          { text: 'Quantity', value: 'quantity' },
          { text: 'Comment', value: 'comment' }
        ],
      }
    },
      methods: {
        rowHighlight(item) {
          switch(item.completed_date) {
            case '':
              return 'orange lighten-4'
            default:
              return 'green lighten-4'
          }
        }
      }
    })

    const AddTaskComponent = {template: '<add-task-component></add-task-component>'}
    Vue.component('add-task-component', {
      template: '#add-task-component-template',
      data() {
        return {
          valid: false,
          name: '',
          nameRules: [
            (v) => !!v || 'Name is required',
            (v) => v.length <= 10 || 'Name must be less than 10 characters'
          ],
          email: '',
          emailRules: [
            (v) => !!v || 'E-mail is required',
            (v) => /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(v) || 'E-mail must be valid'
          ]
        }
      },
      methods: {
        addTask3() {
          return false
        }
      }
    })

    const ChartsComponent = {template: '<charts-component></charts-component>'}
    Vue.component('charts-component', {
      template: '#charts-component-template',
      data() {
        return {}
      },
      methods: {
        addTask4() {
          return false
        }
      }
    })

    // VueFire
    Vue.use(VueFire)

    const config = {
      apiKey: "AIzaSyB14Gym0u8xrPUVF1CwOrui4WjfNaNPETc",
      authDomain: "tasktracker-c860b.firebaseapp.com",
      databaseURL: "https://tasktracker-c860b.firebaseio.com",
      projectId: "tasktracker-c860b",
      storageBucket: "tasktracker-c860b.appspot.com",
      messagingSenderId: "450430370483"
    }

    const firebaseApp = firebase.initializeApp(config)
    const db = firebaseApp.database()
    const tasksRef = db.ref('/tasks')

    // VueRouter
    Vue.use(VueRouter)

    const router = new VueRouter({
      routes: [
        {
          path: '/', redirect: '/tasks'
        },
        {
          name: 'tasks',
          path: '/tasks',
          component: AddTaskComponent
        },
        {
          name: 'charts',
          path: '/charts',
          component: ChartsComponent
        },
        {
          path: '*',
          redirect: '/tasks'
        }
      ]
    })

    // Vue
    const vm = new Vue({
      el: '#app',
      data,
      firebase: {
        tasks: tasksRef
      },
      router,
      methods: {
        addTask: function () {
          tasksRef.push(this.newTask);
          this.newTask.id = '';
          this.newTask.type = '';
          this.newTask.reporter_id = '';
          this.newTask.created_date = '';
          this.newTask.completed_date = '';
          this.newTask.quantity = '';
          this.newTask.comment = '';
        },
        editTask: function(task) {
          // Set post values to form
          this.newTask = task
        },
        updateTask: function(task) {
          const childKey = task['.key']
          // Firebase doesn't accept speacial chars as value
          // so delete `.key` property from the post
          delete task['.key']
          // Set the updated post value
          this.$firebaseRefs.tasks.child(childKey).set(task)
        }, 
        removeTask: function (task) {
          tasksRef.child(task['.key']).remove()
          // toastr.success('Book removed successfully')
        }
      }
    })
  </script>
</body>
</html>
